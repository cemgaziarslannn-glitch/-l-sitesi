<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>G√ºvenlik Kayƒ±t Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
  h1 { text-align:center; color:#004d99; margin-bottom:40px; }
  #totalCount { position: fixed; top: 6px; left: 6px; font-weight:600; font-size:12px; color:#004d99; background:#d9e7ff; padding:4px 8px; border-radius:4px; box-shadow:0 0 4px rgba(0,77,153,0.2); user-select:none; z-index:10001; }
  #searchContainer { text-align:center; margin-bottom:20px; }
  #searchInput { max-width:400px; padding:12px 15px; font-size:18px; border-radius:5px; border:1px solid #ccc; }
  #voiceSearchBtn, #cameraBtn { padding:12px 15px; font-size:18px; border-radius:5px; border:1px solid #ccc; cursor:pointer; background:#006699; color:white; margin-left:5px; }
  #voiceSearchBtn:hover, #cameraBtn:hover { background:#004466; }
  table { width:100%; max-width:600px; margin:0 auto; border-collapse:collapse; background:white; box-shadow:0 0 8px rgba(0,0,0,0.1); border-radius:8px; overflow:hidden; }
  th, td { padding:14px 16px; border-bottom:1px solid #ddd; text-align:left; }
  th { background:#004d99; color:white; }
  tr:hover { background:#f5faff; }
  #noResults { text-align:center; margin-top:20px; color:#666; display:none; }
  #buttonContainer { position: fixed; bottom: 20px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:10000; }
  #buttonContainer button { background:#006699; color:white; border:none; padding:6px 10px; font-size:12px; border-radius:4px; cursor:pointer; user-select:none; min-width:80px; box-shadow:0 1px 3px rgba(0,0,0,0.2); transition: background-color 0.25s ease; }
  #buttonContainer button:hover { background:#004466; }
  #deleteAllBtn { background-color:#dc3545 !important; }
  #deleteAllBtn:hover { background-color:#b52a37 !important; }
  .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px 25px 25px; box-shadow:0 0 15px rgba(0,0,0,0.3); border-radius:12px; z-index:11000; width:320px; }
  .modal input { width:100%; margin:7px 0 12px; padding:10px 12px; font-size:15px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
  .modal button { margin-top:5px; padding:10px; width:100%; background:#004d99; color:white; border:none; border-radius:6px; cursor:pointer; font-size:15px; }
  .modal button:hover { background:#003366; }
  .closeBtn { background:#dc3545 !important; margin-top:10px; }
  #deleteRecord { background:#ff8800 !important; }
  .editBtn { cursor:pointer; color:#004d99; font-weight:700; user-select:none; font-size:18px; }
  .editBtn:hover { color:#002244; }
  #cameraContainer { text-align:center; margin:10px 0; position:relative; }
  #video { border:1px solid #ccc; display:none; }
  #canvas { display:none; }
  #overlay { position:absolute; border:2px solid red; width:200px; height:60px; top:50%; left:50%; transform:translate(-50%,-50%); pointer-events:none; display:none; }
  #takePhotoBtn { display:none; padding:8px 12px; margin-top:5px; }
</style>
</head>
<body>
<h1>G√ºvenlik Kayƒ±t Sistemi</h1>
<div id="totalCount">Toplam Kayƒ±t: 0</div>

<!-- Arama ve Ses/Kamera -->
<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Blok, Daire, ƒ∞sim veya Plaka ile ara..." />
  <button id="voiceSearchBtn" title="Sesli Ara">üéôÔ∏è</button>
  <button id="cameraBtn" title="Plaka Tara üì∑">üì∑</button>
</div>

<table id="recordTable">
  <thead>
    <tr>
      <th>Blok</th>
      <th>Daire</th>
      <th>ƒ∞sim</th>
      <th>Plaka</th>
      <th>ƒ∞≈ülem</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p id="noResults">Kayƒ±t bulunamadƒ±.</p>

<!-- Alt butonlar -->
<div id="buttonContainer">
  <button id="allRecordsBtn">T√ºm Kayƒ±tlar</button>
  <button id="adminBtn">Kayƒ±t Ekle</button>
  <button id="deleteAllBtn">Kayƒ±tlarƒ± Sil</button>
</div>

<!-- Kamera ve Overlay -->
<div id="cameraContainer">
  <video id="video" width="320" height="240" autoplay></video>
  <canvas id="canvas" width="320" height="240"></canvas>
  <div id="overlay"></div>
  <button id="takePhotoBtn">Fotoƒüraf √áek</button>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="modal">
  <h3 id="adminPanelTitle">Yeni Kayƒ±t Ekle</h3>
  <input type="text" id="blok" placeholder="Blok (√∂rn: C)" />
  <input type="text" id="daire" placeholder="Daire No (√∂rn: 23)" />
  <input type="text" id="isim" placeholder="ƒ∞sim" />
  <input type="text" id="plaka" placeholder="Plaka (opsiyonel)" />
  <button id="saveRecord">Kaydet</button>
  <button id="deleteRecord" class="closeBtn" style="display:none">Sil</button>
  <button class="closeBtn" onclick="closeAdminPanel()">Kapat</button>
</div>

<!-- ≈ûifre Paneli -->
<div id="passwordPanel" class="modal">
  <h3 id="passTitle">≈ûifre Giri≈üi</h3>
  <input type="password" id="passwordInput" placeholder="≈ûifre" autocomplete="new-password"/>
  <button id="passwordSubmit">Giri≈ü Yap</button>
  <button class="closeBtn" onclick="closePasswordPanel()">Kapat</button>
</div>

<script>
let records = JSON.parse(localStorage.getItem("guvenlikRecords") || "[]");
let savedPassword = localStorage.getItem("adminPassword") || "";
const tableBody = document.querySelector("#recordTable tbody");
const searchInput = document.getElementById("searchInput");
const noResults = document.getElementById("noResults");
const totalCountDiv = document.getElementById("totalCount");

const allRecordsBtn = document.getElementById("allRecordsBtn");
const adminBtn = document.getElementById("adminBtn");
const deleteAllBtn = document.getElementById("deleteAllBtn");
const adminPanel = document.getElementById("adminPanel");
const blokInput = document.getElementById("blok");
const daireInput = document.getElementById("daire");
const isimInput = document.getElementById("isim");
const plakaInput = document.getElementById("plaka");
const saveBtn = document.getElementById("saveRecord");
const deleteBtn = document.getElementById("deleteRecord");
const passwordPanel = document.getElementById("passwordPanel");
const passwordInput = document.getElementById("passwordInput");
const passwordSubmit = document.getElementById("passwordSubmit");
let editingIndex = null;
let showingAll = false;

function updateTotalCount(){ totalCountDiv.textContent = `Toplam Kayƒ±t: ${records.length}`; }
function renderTable(data){ 
  tableBody.innerHTML=""; 
  if(data.length===0){ noResults.style.display = searchInput.value.trim()?"block":"none"; return;} 
  noResults.style.display="none"; 
  data.forEach((rec,i)=>{ 
    const tr=document.createElement("tr"); 
    tr.innerHTML=`<td>${rec.blok}</td><td>${rec.daire}</td><td>${rec.isim}</td><td>${rec.plaka||""}</td><td><span class="editBtn" data-index="${i}">&#9998;</span></td>`; 
    tableBody.appendChild(tr); 
  });
}
function smartSearch(query){
  query=query.trim().toLowerCase();
  if(!query) return [];
  return records.filter(r=>{
    const full=(r.blok+r.daire).toLowerCase();
    return r.blok.toLowerCase().includes(query)||r.daire.toLowerCase().includes(query)||full.includes(query)||r.isim.toLowerCase().includes(query)||(r.plaka&&r.plaka.toLowerCase().includes(query));
  });
}
searchInput.addEventListener("input",(e)=>renderTable(smartSearch(e.target.value)));

const voiceSearchBtn=document.getElementById("voiceSearchBtn");
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if(SpeechRecognition){
  const recognition=new SpeechRecognition();
  recognition.lang="tr-TR";
  recognition.interimResults=false;
  voiceSearchBtn.addEventListener("click",()=>recognition.start());
  recognition.addEventListener("result",(event)=>{
    const spokenText=event.results[0][0].transcript;
    searchInput.value=spokenText;
    renderTable(smartSearch(spokenText));
  });
}

function askPassword(callback){
  passwordInput.value="";
  passwordPanel.style.display="block";
  passwordSubmit.onclick=()=>{
    if(!savedPassword){ savedPassword=passwordInput.value; if(!savedPassword) return alert("≈ûifre bo≈ü olamaz!"); localStorage.setItem("adminPassword", savedPassword); passwordPanel.style.display="none"; callback(); }
    else{ if(passwordInput.value===savedPassword){ passwordPanel.style.display="none"; callback(); } else alert("Hatalƒ± ≈üifre!"); }
  };
}
function closePasswordPanel(){ passwordPanel.style.display="none"; }

allRecordsBtn.addEventListener("click",()=>askPassword(()=>{
  showingAll=!showingAll;
  allRecordsBtn.textContent=showingAll?"Sorgu Ekranƒ±nƒ± Gizle":"T√ºm Kayƒ±tlar";
  searchInput.value="";
  renderTable(showingAll?records:[]);
  noResults.style.display=showingAll&&records.length===0?"block":"none";
}));

adminBtn.addEventListener("click",()=>askPassword(()=>openAdminPanel()));

function openAdminPanel(edit=false){ adminPanel.style.display="block"; if(edit&&editingIndex!==null){ const rec=records[editingIndex]; blokInput.value=rec.blok; daireInput.value=rec.daire; isimInput.value=rec.isim; plakaInput.value=rec.plaka||""; deleteBtn.style.display="block"; } else{ blokInput.value=daireInput.value=isimInput.value=plakaInput.value=""; editingIndex=null; deleteBtn.style.display="none"; } }
function closeAdminPanel(){ adminPanel.style.display="none"; }
saveBtn.addEventListener("click",()=>{
  const blok=blokInput.value.trim(), daire=daireInput.value.trim(), isim=isimInput.value.trim(), plaka=plakaInput.value.trim();
  if(!blok||!daire||!isim) return alert("Blok, Daire ve ƒ∞sim bo≈ü olamaz.");
  if(editingIndex!==null){ records[editingIndex]={blok,daire,isim,plaka}; editingIndex=null; } else records.push({blok,daire,isim,plaka});
  localStorage.setItem("guvenlikRecords",JSON.stringify(records));
  updateTotalCount();
  renderTable([]);
  closeAdminPanel();
  alert("Kayƒ±t kaydedildi.");
});
deleteBtn.addEventListener("click",()=>{ if(editingIndex!==null&&confirm("Bu kaydƒ± silmek istiyor musunuz?")){ records.splice(editingIndex,1); localStorage.setItem("guvenlikRecords",JSON.stringify(records)); updateTotalCount(); renderTable([]); closeAdminPanel(); alert("Kayƒ±t silindi."); editingIndex=null; } });
tableBody.addEventListener("click",(e)=>{ if(e.target.classList.contains("editBtn")){ editingIndex=Number(e.target.getAttribute("data-index")); askPassword(()=>openAdminPanel(true)); } });

deleteAllBtn.addEventListener("click",()=>askPassword(()=>{ const botCheck=prompt("L√ºtfen 'Ben robot deƒüilim' yazƒ±nƒ±z:"); if(botCheck&&botCheck.trim().toLowerCase()==="ben robot deƒüilim"){ if(confirm("T√ºm kayƒ±tlarƒ± silmek istediƒüinize emin misiniz?")){ records=[]; localStorage.setItem("guvenlikRecords",JSON.stringify(records)); updateTotalCount(); renderTable([]); alert("T√ºm kayƒ±tlar silindi."); } } else alert("Bot doƒürulamasƒ± ba≈üarƒ±sƒ±z!"); }));

updateTotalCount();
renderTable([]);

// ----------------------- Kamera & OCR -----------------------
const cameraBtn=document.getElementById("cameraBtn");
const video=document.getElementById("video");
const overlay=document.getElementById("overlay");
const canvas=document.getElementById("canvas");
const takePhotoBtn=document.getElementById("takePhotoBtn");

let stream=null;
cameraBtn.addEventListener("click", async ()=>{
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
    video.style.display="block";
    overlay.style.display="block";
    takePhotoBtn.style.display="inline-block";
  } catch(e){ alert("Kamera a√ßƒ±lamadƒ±: "+e.message); }
});

takePhotoBtn.addEventListener("click",()=>{
  const ctx=canvas.getContext("2d");
  // Kƒ±rmƒ±zƒ± kutu koordinatlarƒ±
  const rect=overlay.getBoundingClientRect();
  const videoRect=video.getBoundingClientRect();
  const scaleX=video.videoWidth/videoRect.width;
  const scaleY=video.videoHeight/videoRect.height;
  const sx=(rect.left-videoRect.left)*scaleX;
  const sy=(rect.top-videoRect.top)*scaleY;
  const sw=rect.width*scaleX;
  const sh=rect.height*scaleY;
  // Crop
  ctx.drawImage(video,sx,sy,sw,sh,0,0,sw,sh);
  const dataURL=canvas.toDataURL("image/png");
  // OCR
  Tesseract.recognize(dataURL,'eng',{logger:m=>console.log(m)}).then(({data:{text}})=>{
    const detectedPlate=text.replace(/\s/g,"").toUpperCase();
    searchInput.value=detectedPlate;
    renderTable(smartSearch(detectedPlate));
    alert("OCR Sonucu: "+detectedPlate);
  });
  // Kamera kapat
  video.style.display="none";
  overlay.style.display="none";
  takePhotoBtn.style.display="none";
  if(stream){ stream.getTracks().forEach(track=>track.stop()); stream=null; }
});
</script>
</body>
</html>
